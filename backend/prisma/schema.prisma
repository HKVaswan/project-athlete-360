generator client {
  provider = "prisma-client-js"
  output   = "node_modules/@prisma/client"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

enum PaymentStatus {
  PENDING
  COMPLETED
  FAILED
  REFUNDED
  CANCELLED
}

enum PaymentProvider {
  STRIPE
  RAZORPAY
  MANUAL
}

/*
 Roles are defined as identifiers that match exact string values used in code:
  - athlete
  - coach
  - admin
  - super_admin
*/
enum Role {
  athlete
  coach
  admin
  super_admin
}

model User {
  id             String    @id @default(uuid())
  createdAt      DateTime  @default(now())
  updatedAt      DateTime  @updatedAt
  username       String?   @unique
  email          String?   @unique
  name           String?
  passwordHash   String?
  role           Role      @default(athlete)
  sessionVersion Int       @default(0)
  coachCode      String?   @unique
  institutionId  String?   
  institution    Institution? @relation(fields: [institutionId], references: [id])
  athlete        Athlete?     @relation(fields: [], references: [])
  sessions       Session[]
  invites        Invitation[]
  // relations
  messagesSent   Message[]    @relation("message_sender")
  messagesRecvd  Message[]    @relation("message_receiver")
  audits         AuditEntry[] @relation("audit_actor")
  @@index([institutionId])
}

model Athlete {
  id            String   @id @default(uuid())
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt
  userId        String   @unique
  user          User     @relation(fields: [userId], references: [id])
  athleteCode   String   @unique
  name          String?
  dob           DateTime?
  gender        String?
  sport         String?
  contactInfo   String?
  institutionId String?
  institution   Institution? @relation(fields: [institutionId], references: [id])
  approved      Boolean  @default(false)
}

model Institution {
  id          String    @id @default(uuid())
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
  name        String
  code        String    @unique
  domain      String?   @unique
  address     String?
  active      Boolean   @default(true)
  planTier    String?   // free / pro / enterprise or similar
  users       User[]
  athletes    Athlete[]
  subscriptions Subscription[]
  quota       Int?      @default(0)
}

model Session {
  id         String   @id @default(uuid())
  userId     String
  user       User     @relation(fields: [userId], references: [id])
  createdAt  DateTime @default(now())
  expiresAt  DateTime?
  ip         String?
  ua         String?
  valid      Boolean  @default(true)
}

model MfaChallenge {
  id         String   @id @default(uuid())
  userId     String
  user       User     @relation(fields: [userId], references: [id])
  code       String
  expiresAt  DateTime
  consumed   Boolean  @default(false)
  createdAt  DateTime  @default(now())
}

model PasswordResetToken {
  id         String   @id @default(uuid())
  userId     String
  user       User     @relation(fields: [userId], references: [id])
  token      String   @unique
  expiresAt  DateTime
  usedAt     DateTime?
  createdAt  DateTime @default(now())
}

model EmailVerification {
  id         String   @id @default(uuid())
  userId     String
  user       User     @relation(fields: [userId], references: [id])
  token      String   @unique
  expiresAt  DateTime
  usedAt     DateTime?
  createdAt  DateTime @default(now())
}

model Invitation {
  id            String   @id @default(uuid())
  createdAt     DateTime @default(now())
  email         String?
  phone         String?
  code          String   @unique
  role          Role
  inviterId     String?
  inviter       User?    @relation(fields: [inviterId], references: [id])
  institutionId String?
  institution   Institution? @relation(fields:[institutionId], references:[id])
  used          Boolean  @default(false)
  expiresAt     DateTime?
}

model AuditEntry {
  id         String   @id @default(uuid())
  createdAt  DateTime @default(now())
  actorId    String?
  actor      User?    @relation(fields: [actorId], references: [id], name: "audit_actor")
  action     String
  resource   String?
  meta       Json?
  ip         String?
  severity   String?
}

model Payment {
  id                String         @id @default(uuid())
  createdAt         DateTime       @default(now())
  updatedAt         DateTime       @updatedAt
  institutionId     String?
  institution       Institution?   @relation(fields: [institutionId], references: [id])
  amountCents       Int
  currency          String         @default("INR")
  status            PaymentStatus  @default(PENDING)
  provider          PaymentProvider
  providerPaymentId String?        @unique
  metadata          Json?
  events            PaymentEvent[]
  notes             String?
}

model PaymentEvent {
  id        String   @id @default(uuid())
  paymentId String
  payment   Payment  @relation(fields: [paymentId], references: [id])
  eventType String
  payload   Json?
  createdAt DateTime @default(now())
}

model MessageThread {
  id          String    @id @default(uuid())
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
  subject     String?
  messages    Message[]
}

model Message {
  id          String    @id @default(uuid())
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
  threadId    String?
  thread      MessageThread? @relation(fields: [threadId], references: [id])
  senderId    String?
  sender      User?      @relation("message_sender", fields: [senderId], references: [id])
  receiverId  String?
  receiver    User?      @relation("message_receiver", fields: [receiverId], references: [id])
  body        String
  metadata    Json?
  readReceipts MessageReadReceipt[]
}

model MessageReadReceipt {
  id         String   @id @default(uuid())
  messageId  String
  message    Message  @relation(fields: [messageId], references: [id])
  userId     String
  user       User     @relation(fields: [userId], references: [id])
  readAt     DateTime @default(now())
}

model Plan {
  id          String   @id @default(uuid())
  name        String
  description String?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
}

model InstitutionPlan {
  id                String   @id @default(uuid())
  institutionId     String
  institution       Institution @relation(fields: [institutionId], references: [id])
  name              String
  maxCoaches        Int      @default(0)
  maxAthletes       Int      @default(0)
  billingPeriodDays Int?
  priceCents        Int?
  currency          String?  @default("INR")
  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt
}

model Subscription {
  id            String   @id @default(uuid())
  institutionId  String
  institution   Institution @relation(fields: [institutionId], references: [id])
  planId        String
  plan          InstitutionPlan @relation(fields: [planId], references: [id])
  startsAt      DateTime
  endsAt        DateTime?
  active        Boolean  @default(true)
  autoRenew     Boolean  @default(false)
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt
}