; ============================================================================
; infra/db/pgbouncer/pgbouncer.conf
; ============================================================================
; ðŸ§  Project Athlete 360 â€” PgBouncer Connection Pooler
;
; Purpose:
;  - Manage and multiplex PostgreSQL connections efficiently.
;  - Prevent connection exhaustion from horizontally scaled API servers.
;  - Enable HA setups with low-latency connection reuse.
;
; Key Features:
;  - Transaction pooling mode for stateless APIs.
;  - Per-database pool sizing for controlled concurrency.
;  - Health check endpoint for readiness probes.
;  - TLS/SSL support for secure DB connectivity.
;  - Logging, admin console, and Prometheus-exporter compatibility.
; ============================================================================


[databases]
; Format: database_name = host=<host> port=<port> dbname=<name> user=<user> password=<pass>
; For multi-tenant setup, you can map several institutions via templated names.
project_athlete_360 = host=${DB_HOST:-postgres} port=${DB_PORT:-5432} dbname=${DB_NAME:-pa360} user=${DB_USER:-pa360_user} password=${DB_PASS:-secret} pool_size=50

; Optionally configure replicas for analytics / read scaling
project_athlete_360_read = host=${DB_REPLICA_HOST:-postgres-replica} port=5432 dbname=${DB_NAME:-pa360} user=${DB_USER:-pa360_user} password=${DB_PASS:-secret} pool_size=25


[pgbouncer]
; --------------------------------------------------------------------------
; Connection Settings
; --------------------------------------------------------------------------
listen_addr = 0.0.0.0
listen_port = ${PGBOUNCER_PORT:-6432}
unix_socket_dir = /tmp
auth_type = md5
auth_file = /etc/pgbouncer/userlist.txt
pool_mode = transaction          ; options: session, transaction, statement
max_client_conn = 2000
default_pool_size = 50
min_pool_size = 5
reserve_pool_size = 10
reserve_pool_timeout = 5.0
server_reset_query = DISCARD ALL
ignore_startup_parameters = extra_float_digits

; --------------------------------------------------------------------------
; TLS / SSL (recommended for cloud deployments)
; --------------------------------------------------------------------------
;ssl = on
;ssl_cert_file = /etc/pgbouncer/server.crt
;ssl_key_file = /etc/pgbouncer/server.key
;ssl_ca_file = /etc/pgbouncer/ca.crt

; --------------------------------------------------------------------------
; Timeout & Health Configuration
; --------------------------------------------------------------------------
query_timeout = 600
client_idle_timeout = 300
server_idle_timeout = 600
server_lifetime = 3600
server_connect_timeout = 15
server_login_retry = 15
dns_max_ttl = 60
tcp_keepalive = 1
tcp_keepidle = 300
tcp_keepintvl = 30
tcp_keepcnt = 5

; --------------------------------------------------------------------------
; Logging & Monitoring
; --------------------------------------------------------------------------
log_connections = 1
log_disconnections = 1
log_pooler_errors = 1
log_stats = 1
stats_period = 60
verbose = 0
admin_users = postgres, pa360_admin
stats_users = postgres, pa360_admin

; --------------------------------------------------------------------------
; Prometheus Exporter (optional)
; --------------------------------------------------------------------------
; A separate exporter container can connect to admin console:
; prometheus_exporter = on
; prometheus_listen_addr = 0.0.0.0
; prometheus_listen_port = 9127

; --------------------------------------------------------------------------
; Administrative Console
; --------------------------------------------------------------------------
admin_users = pa360_admin, postgres
admin_console = on

; --------------------------------------------------------------------------
; Health Check Query (used for readiness probes)
; --------------------------------------------------------------------------
; kubectl exec -it <pgbouncer-pod> -- psql -U postgres -p 6432 pgbouncer -c "SHOW POOLS;"
; liveness_query = SELECT 1
; readiness_query = SHOW STATS;

; --------------------------------------------------------------------------
; File Paths
; --------------------------------------------------------------------------
pidfile = /var/run/pgbouncer/pgbouncer.pid
listen_backlog = 1024

; --------------------------------------------------------------------------
; Security & Limits
; --------------------------------------------------------------------------
max_db_connections = 200
max_user_connections = 200
disable_pqexec = 0
server_tls_sslmode = prefer

; --------------------------------------------------------------------------
; Include local override file for environment-specific tuning
; --------------------------------------------------------------------------
; include = /etc/pgbouncer/local_overrides.conf