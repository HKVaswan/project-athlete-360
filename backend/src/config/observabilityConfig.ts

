/**
 * --------------------------------------------------------------------------
 * src/config/observabilityConfig.ts
 * --------------------------------------------------------------------------
 * üõ∞Ô∏è Enterprise Observability Configuration
 *
 * Purpose:
 *  - Unified setup for Metrics + Tracing + Resource metadata
 *  - Safe defaults for local, staging, and production environments
 *  - Seamless Prometheus + OpenTelemetry integration
 *
 * Features:
 *  - Auto-instrumentation (HTTP, Express, Prisma, Redis, PG)
 *  - Configurable exporters (OTLP, Prometheus)
 *  - Structured telemetry resource metadata
 *  - Graceful fallback and shutdown
 * --------------------------------------------------------------------------
 */

import { config } from "./index";
import { logger } from "../logger";
import { diag, DiagConsoleLogger, DiagLogLevel } from "@opentelemetry/api";
import { Resource } from "@opentelemetry/resources";
import { SemanticResourceAttributes } from "@opentelemetry/semantic-conventions";
import { NodeSDK } from "@opentelemetry/sdk-node";
import { OTLPTraceExporter } from "@opentelemetry/exporter-trace-otlp-http";
import { PrometheusExporter } from "@opentelemetry/exporter-prometheus";
import { PeriodicExportingMetricReader } from "@opentelemetry/sdk-metrics";
import { HttpInstrumentation } from "@opentelemetry/instrumentation-http";
import { ExpressInstrumentation } from "@opentelemetry/instrumentation-express";
import { PrismaInstrumentation } from "@prisma/instrumentation";
import { RedisInstrumentation } from "@opentelemetry/instrumentation-redis";
import { PgInstrumentation } from "@opentelemetry/instrumentation-pg";
import os from "os";

/* --------------------------------------------------------------------------
   üß† Diagnostics Setup (Safe for non-prod)
-------------------------------------------------------------------------- */
if (config.NODE_ENV !== "production") {
  diag.setLogger(new DiagConsoleLogger(), DiagLogLevel.WARN);
}

/* --------------------------------------------------------------------------
   üåç Environment-aware Observability Configuration
-------------------------------------------------------------------------- */
export const observabilityConfig = {
  enabled: config.OBSERVABILITY_ENABLED ?? true,
  metricsPort: Number(process.env.METRICS_PORT || 9464),
  metricsPath: process.env.METRICS_PATH || "/metrics",
  serviceName: process.env.OTEL_SERVICE_NAME || "pa360-backend",
  otlpEndpoint: process.env.OTLP_ENDPOINT || "http://localhost:4318/v1/traces",
  otlpHeaders: process.env.OTLP_HEADERS || "",
  prometheusEnabled: process.env.PROMETHEUS_ENABLED !== "false",
  samplingRate: Number(process.env.TRACE_SAMPLING_RATE || 1.0),
  cloudProvider: process.env.CLOUD_PROVIDER || "local",
  instanceId: os.hostname(),
};

/* --------------------------------------------------------------------------
   üìà Prometheus Metrics Exporter (Local metrics scraping)
-------------------------------------------------------------------------- */
let prometheusExporter: PrometheusExporter | undefined;
if (observabilityConfig.prometheusEnabled) {
  prometheusExporter = new PrometheusExporter(
    {
      port: observabilityConfig.metricsPort,
      endpoint: observabilityConfig.metricsPath,
      startServer: true,
    },
    () => logger.info(`[OBSERVABILITY] üìä Prometheus metrics at :${observabilityConfig.metricsPort}${observabilityConfig.metricsPath}`)
  );
}

/* --------------------------------------------------------------------------
   üåê OTLP Trace Exporter (for distributed tracing)
-------------------------------------------------------------------------- */
let traceExporter: OTLPTraceExporter | undefined;
try {
  traceExporter = new OTLPTraceExporter({
    url: observabilityConfig.otlpEndpoint,
    headers: observabilityConfig.otlpHeaders
      ? JSON.parse(observabilityConfig.otlpHeaders)
      : undefined,
  });
} catch (err: any) {
  logger.warn("[OBSERVABILITY] ‚ö†Ô∏è Failed to initialize OTLP exporter", { err });
}

/* --------------------------------------------------------------------------
   üß© Resource Metadata
-------------------------------------------------------------------------- */
const resource = new Resource({
  [SemanticResourceAttributes.SERVICE_NAME]: observabilityConfig.serviceName,
  [SemanticResourceAttributes.SERVICE_NAMESPACE]: "project-athlete-360",
  [SemanticResourceAttributes.DEPLOYMENT_ENVIRONMENT]: config.NODE_ENV,
  [SemanticResourceAttributes.CLOUD_PROVIDER]: observabilityConfig.cloudProvider,
  [SemanticResourceAttributes.SERVICE_VERSION]: process.env.APP_VERSION || "v1",
  [SemanticResourceAttributes.HOST_NAME]: os.hostname(),
  [SemanticResourceAttributes.PROCESS_PID]: process.pid,
});

/* --------------------------------------------------------------------------
   üß∞ OpenTelemetry Node SDK Setup
-------------------------------------------------------------------------- */
export const otelSDK = new NodeSDK({
  resource,
  traceExporter: traceExporter ?? undefined,
  metricReader: prometheusExporter
    ? new PeriodicExportingMetricReader({ exporter: prometheusExporter })
    : undefined,
  instrumentations: [
    new HttpInstrumentation(),
    new ExpressInstrumentation(),
    new PrismaInstrumentation(),
    new RedisInstrumentation(),
    new PgInstrumentation(),
  ],
});

/* --------------------------------------------------------------------------
   üöÄ Initialization Function
-------------------------------------------------------------------------- */
let started = false;

export const initObservability = async () => {
  if (!observabilityConfig.enabled) {
    logger.info("[OBSERVABILITY] Disabled by configuration.");
    return;
  }

  if (started) {
    logger.warn("[OBSERVABILITY] SDK already started ‚Äî skipping.");
    return;
  }

  try {
    await otelSDK.start();
    started = true;
    logger.info(`[OBSERVABILITY] ‚úÖ OpenTelemetry started for ${observabilityConfig.serviceName}`);
    logger.debug({
      service: observabilityConfig.serviceName,
      otlpEndpoint: observabilityConfig.otlpEndpoint,
      prometheus: observabilityConfig.prometheusEnabled,
      samplingRate: observabilityConfig.samplingRate,
    });
  } catch (err: any) {
    logger.error("[OBSERVABILITY] ‚ùå Failed to initialize telemetry", { err });
  }
};

/* --------------------------------------------------------------------------
   üßπ Graceful Shutdown Hook
-------------------------------------------------------------------------- */
export const shutdownObservability = async () => {
  if (!started) return;
  try {
    await otelSDK.shutdown();
    started = false;
    logger.info("[OBSERVABILITY] üßπ Telemetry shutdown complete.");
  } catch (err: any) {
    logger.error("[OBSERVABILITY] ‚ö†Ô∏è Error during telemetry shutdown", { err });
  }
};

/* --------------------------------------------------------------------------
   üì¶ Exports
-------------------------------------------------------------------------- */
export default {
  initObservability,
  shutdownObservability,
  observabilityConfig,
  prometheusExporter,
  traceExporter,
  otelSDK,
};