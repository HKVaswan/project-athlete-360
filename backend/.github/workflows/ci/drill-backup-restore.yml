name: üß™ DR Drill ‚Äî Automated Backup & Restore Validation

on:
  workflow_dispatch:
  schedule:
    - cron: "0 3 * * 0" # Every Sunday at 3 AM UTC (customize as needed)

permissions:
  contents: read

env:
  NODE_ENV: test
  TZ: "Asia/Kolkata"

jobs:
  drill-backup-restore:
    name: üß± Simulate Full Backup ‚Üí Restore ‚Üí Verify
    runs-on: ubuntu-latest
    timeout-minutes: 30

    services:
      postgres:
        image: postgres:15
        ports: ["5432:5432"]
        env:
          POSTGRES_DB: pa360_test
          POSTGRES_USER: postgres
          POSTGRES_PASSWORD: postgres
        options: >-
          --health-cmd="pg_isready -U postgres"
          --health-interval=10s
          --health-timeout=5s
          --health-retries=5

    steps:
      - name: üß© Checkout Repository
        uses: actions/checkout@v4

      - name: ‚öôÔ∏è Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20

      - name: üì¶ Install Dependencies
        run: npm ci

      - name: üß† Setup Environment
        run: |
          echo "DATABASE_URL=postgresql://postgres:postgres@localhost:5432/pa360_test" >> .env
          echo "MASTER_KEY=${{ secrets.MASTER_KEY }}" >> .env
          echo "BACKUP_ENCRYPTION_KEY=${{ secrets.BACKUP_ENCRYPTION_KEY }}" >> .env
          echo "JWT_SECRET=${{ secrets.JWT_SECRET }}" >> .env
          echo "ENCRYPTION_KEY=${{ secrets.ENCRYPTION_KEY }}" >> .env
          echo "AWS_ACCESS_KEY_ID=${{ secrets.AWS_ACCESS_KEY_ID }}" >> .env
          echo "AWS_SECRET_ACCESS_KEY=${{ secrets.AWS_SECRET_ACCESS_KEY }}" >> .env
          echo "AWS_REGION=ap-south-1" >> .env
          echo "TEST_BACKUP_BUCKET=pa360-drill-test" >> .env

      - name: üóÉÔ∏è Setup Database Schema
        run: npx prisma migrate deploy
        env:
          DATABASE_URL: "postgresql://postgres:postgres@localhost:5432/pa360_test"

      - name: üß© Run Backup ‚Üí Restore Integration Test
        run: |
          echo "Running full backup ‚Üí restore pipeline test..."
          npm run test:integration -- --runInBand
        env:
          DATABASE_URL: "postgresql://postgres:postgres@localhost:5432/pa360_test"

      - name: üîê Run Backup Encryption Test
        run: |
          echo "Running encryption validation test..."
          npm run test:encryption -- --runInBand

      - name: üìä Generate Restore Drill Report
        run: |
          mkdir -p reports
          echo "-------------------------------------" > reports/restore_drill_report.txt
          echo "üèóÔ∏è Project Athlete 360 - Backup & Restore Drill" >> reports/restore_drill_report.txt
          echo "Timestamp: $(date -u)" >> reports/restore_drill_report.txt
          echo "Database: pa360_test" >> reports/restore_drill_report.txt
          echo "Environment: CI (Ephemeral)" >> reports/restore_drill_report.txt
          echo "Status: ‚úÖ PASSED" >> reports/restore_drill_report.txt
          echo "-------------------------------------" >> reports/restore_drill_report.txt

      - name: üì§ Upload Drill Report Artifact
        uses: actions/upload-artifact@v4
        with:
          name: restore-drill-report
          path: reports/restore_drill_report.txt

      - name: üö® Notify on Failure (Email)
        if: failure()
        uses: dawidd6/action-send-mail@v3
        with:
          server_address: smtp.gmail.com
          server_port: 465
          username: ${{ secrets.SMTP_USER }}
          password: ${{ secrets.SMTP_PASS }}
          subject: "‚ùå [Project Athlete 360] Backup/Restore Drill Failed"
          body: |
            Hello Team,
            The automated backup-restore drill has failed.
            Please check GitHub Actions logs for more details.

            Regards,
            CI Bot ‚Äî Project Athlete 360
          to: admin@pa360.net
          from: "ci-bot@pa360.net"

      - name: üí¨ Optional: Slack Notification (Success)
        if: success()
        uses: rtCamp/action-slack-notify@v2
        env:
          SLACK_WEBHOOK: ${{ secrets.SLACK_WEBHOOK }}
          SLACK_COLOR: good
          SLACK_MESSAGE: |
            ‚úÖ *Backup & Restore Drill Passed Successfully*
            ‚Ä¢ Environment: CI (Test DB)
            ‚Ä¢ Status: PASS
            ‚Ä¢ Timestamp: $(date -u)