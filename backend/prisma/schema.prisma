// prisma/schema.prisma
// -----------------------------------------------------------------------------
// ðŸš€ Enterprise-Grade Prisma Schema â€” Project Athlete 360
// Database: PostgreSQL (configure DATABASE_URL in .env)
// -----------------------------------------------------------------------------

generator client {
  provider        = "prisma-client-js"
  previewFeatures = ["clientExtensions"]
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// -----------------------------------------------------------------------------
// ENUMS
// -----------------------------------------------------------------------------

enum Role {
  ATHLETE
  COACH
  ADMIN
  SUPER_ADMIN
  SYSTEM
}

enum SubscriptionStatus {
  TRIALING
  ACTIVE
  PAST_DUE
  CANCELED
  SUSPENDED
  EXPIRED
}

enum InvoiceStatus {
  DRAFT
  PENDING
  PAID
  FAILED
  VOID
}

enum InvitationStatus {
  PENDING
  ACCEPTED
  REVOKED
  EXPIRED
}

enum Attendance {
  PRESENT
  ABSENT
  EXCUSED
}

enum BillingProvider {
  STRIPE
  RAZORPAY
  MANUAL
}

enum BillingTransactionStatus {
  PENDING
  SUCCEEDED
  FAILED
  REFUNDED
  FLAGGED
}

// -----------------------------------------------------------------------------
// CORE MODELS
// -----------------------------------------------------------------------------

model User {
  id              String        @id @default(uuid())
  username        String        @unique
  email           String?       @unique
  passwordHash    String
  name            String?
  role            Role          @default(ATHLETE)
  institution     Institution?  @relation(fields: [institutionId], references: [id], onDelete: SetNull)
  institutionId   String?
  athlete         Athlete?
  coach           Coach?
  createdAt       DateTime      @default(now())
  updatedAt       DateTime      @updatedAt
  loginSessions   LoginSession[]
  refreshTokens   RefreshToken[]
  notifications   Notification[]
  invitations     Invitation[]  @relation("InvitedBy")
  acceptedInvites Invitation[]  @relation("AcceptedBy")
  auditLogs       AuditLog[]
  meta            Json?
  deleted         Boolean       @default(false)
  deletedAt       DateTime?

  @@index([email])
  @@index([role])
}

model Institution {
  id                  String            @id @default(uuid())
  name                String
  code                String            @unique
  domain              String?           @unique
  createdAt           DateTime          @default(now())
  updatedAt           DateTime          @updatedAt
  users               User[]
  coaches             CoachInstitution[]
  athletes            Athlete[]
  invitations         Invitation[]
  subscriptions       Subscription[]
  usage               InstitutionUsage?
  paymentMethods      PaymentMethod[]
  invoices            Invoice[]
  systemBackups       SystemBackup[]
  trialAbuseLogs      TrialAbuseLog[]
  presignedUploads    PresignedUpload[]
  billingTransactions BillingTransaction[]
  meta                Json?

  @@index([code])
  @@index([domain])
}

// -----------------------------------------------------------------------------
// ATHLETE / COACH RELATIONSHIPS
// -----------------------------------------------------------------------------

model Athlete {
  id             String        @id @default(uuid())
  user           User          @relation(fields: [userId], references: [id], onDelete: Cascade)
  userId         String        @unique
  athleteCode    String        @unique
  name           String
  dob            DateTime?
  sport          String?
  gender         String?
  contactInfo    String?
  approved       Boolean       @default(false)
  institution    Institution?  @relation(fields: [institutionId], references: [id], onDelete: SetNull)
  institutionId  String?
  sessions       Session[]
  analytics      AthleteAnalytics?
  createdAt      DateTime      @default(now())
  updatedAt      DateTime      @updatedAt
  meta           Json?
  deleted        Boolean       @default(false)
  deletedAt      DateTime?

  @@index([athleteCode])
  @@index([institutionId])
}

model Coach {
  id             String              @id @default(uuid())
  user           User                @relation(fields: [userId], references: [id], onDelete: Cascade)
  userId         String              @unique
  coachCode      String              @unique
  name           String?
  institutions   CoachInstitution[]
  createdAt      DateTime            @default(now())
  updatedAt      DateTime            @updatedAt
  meta           Json?
  deleted        Boolean             @default(false)
  deletedAt      DateTime?

  @@index([coachCode])
}

model CoachInstitution {
  id             String      @id @default(uuid())
  coach          Coach       @relation(fields: [coachId], references: [id], onDelete: Cascade)
  coachId        String
  institution    Institution @relation(fields: [institutionId], references: [id], onDelete: Cascade)
  institutionId  String
  createdAt      DateTime    @default(now())

  @@unique([coachId, institutionId])
  @@index([institutionId])
}

// -----------------------------------------------------------------------------
// SESSIONS / PERFORMANCE
// -----------------------------------------------------------------------------

model Session {
  id               String      @id @default(uuid())
  athlete          Athlete     @relation(fields: [athleteId], references: [id], onDelete: Cascade)
  athleteId        String
  coachId          String?
  attendance       Attendance?
  performanceScore Float?
  notes            String?
  createdAt        DateTime    @default(now())
  updatedAt        DateTime    @updatedAt
  meta             Json?

  @@index([athleteId])
  @@index([createdAt])
}

// -----------------------------------------------------------------------------
// INVITATIONS
// -----------------------------------------------------------------------------

model Invitation {
  id              String            @id @default(uuid())
  email           String
  role            Role
  tokenHash       String
  invitedBy       User              @relation("InvitedBy", fields: [invitedById], references: [id], onDelete: Cascade)
  invitedById     String
  institution     Institution       @relation(fields: [institutionId], references: [id], onDelete: Cascade)
  institutionId   String
  acceptedBy      User?             @relation("AcceptedBy", fields: [acceptedById], references: [id], onDelete: SetNull)
  acceptedById    String?
  status          InvitationStatus  @default(PENDING)
  message         String?
  expiresAt       DateTime
  acceptedAt      DateTime?
  revokedAt       DateTime?
  revokeReason    String?
  createdAt       DateTime          @default(now())
  updatedAt       DateTime          @updatedAt

  @@index([email])
  @@index([status])
  @@index([tokenHash])
}

// -----------------------------------------------------------------------------
// SECURITY / AUTHENTICATION
// -----------------------------------------------------------------------------

model RefreshToken {
  id          String   @id @default(uuid())
  user        User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  userId      String
  tokenHash   String
  deviceInfo  String?
  issuedAt    DateTime @default(now())
  expiresAt   DateTime
  revoked     Boolean  @default(false)
  createdAt   DateTime @default(now())

  @@index([userId])
  @@index([tokenHash])
}

model LoginSession {
  id          String   @id @default(uuid())
  user        User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  userId      String
  ipAddress   String?
  userAgent   String?
  loggedInAt  DateTime @default(now())
  meta        Json?
  createdAt   DateTime @default(now())

  @@index([userId])
}

// -----------------------------------------------------------------------------
// BILLING / PLANS
// -----------------------------------------------------------------------------

model Plan {
  id                    String    @id @default(uuid())
  sku                   String    @unique
  name                  String
  description           String?
  priceMonthlyCents     Int       @default(0)
  storageLimitBytes     BigInt    @default(0)
  videoLimitPerMonth    Int       @default(0)
  athletesPerCoach      Int       @default(50)
  coachesPerInstitution Int       @default(10)
  features              Json?
  isDefault             Boolean   @default(false)
  createdAt             DateTime  @default(now())
  updatedAt             DateTime  @updatedAt
  subscriptions         Subscription[]

  @@index([sku])
}

model Subscription {
  id                      String             @id @default(uuid())
  institution              Institution        @relation(fields: [institutionId], references: [id], onDelete: Cascade)
  institutionId            String
  plan                     Plan               @relation(fields: [planId], references: [id], onDelete: Restrict)
  planId                   String
  status                   SubscriptionStatus @default(TRIALING)
  startDate                DateTime           @default(now())
  endDate                  DateTime?
  nextBillingDate          DateTime?
  paymentProvider          BillingProvider?
  providerCustomerId       String?
  providerSubscriptionId   String?
  usedFreeTrial            Boolean            @default(false)
  autoRenew                Boolean            @default(true)
  canceledAt               DateTime?
  invoices                 Invoice[]
  createdAt                DateTime           @default(now())
  updatedAt                DateTime           @updatedAt

  @@index([institutionId])
  @@index([status])
}

// -----------------------------------------------------------------------------
// NOTIFICATIONS (NEWLY ADDED)
// -----------------------------------------------------------------------------

model Notification {
  id             String    @id @default(uuid())
  user           User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  userId         String
  title          String
  message        String
  type           String    @default("GENERAL") // SYSTEM | BILLING | ALERT | ACHIEVEMENT
  priority       String    @default("normal")  // low | normal | high
  channel        String?   // push | email | in-app
  read           Boolean   @default(false)
  readAt         DateTime?
  delivered      Boolean   @default(false)
  deliveredAt    DateTime?
  metadata       Json?
  createdAt      DateTime  @default(now())
  updatedAt      DateTime  @updatedAt

  @@index([userId])
  @@index([type])
  @@index([priority])
  @@index([createdAt])
}

// -----------------------------------------------------------------------------
// ANALYTICS
// -----------------------------------------------------------------------------

model AthleteAnalytics {
  athleteId      String   @id
  avgScore       Float?
  attendanceRate Float?
  updatedAt      DateTime @updatedAt
}

model InstitutionAnalytics {
  institutionId  String   @id
  avgPerformance Float?
  attendanceRate Float?
  updatedAt      DateTime @updatedAt
}

// -----------------------------------------------------------------------------
// SYSTEM / BILLING / SECURITY MODELS (Required for completeness)
// -----------------------------------------------------------------------------

model AuditLog {
  id           String   @id @default(uuid())
  actorId      String?
  actorRole    String?
  action       String
  entity       String?
  entityId     String?
  details      Json?
  metadata     Json?
  chainHash    String
  previousHash String?
  createdAt    DateTime @default(now())

  @@index([actorId])
  @@index([action])
  @@index([createdAt])
}

model InstitutionUsage {
  institution      Institution @relation(fields: [institutionId], references: [id], onDelete: Cascade)
  institutionId    String      @id
  storageBytes     BigInt      @default(0)
  videoCountMonth  Int         @default(0)
  athletesCount    Int         @default(0)
  coachesCount     Int         @default(0)
  lastReconciledAt DateTime?
  updatedAt        DateTime    @updatedAt
  meta             Json?
}

model PaymentMethod {
  id                 String      @id @default(uuid())
  institution        Institution @relation(fields: [institutionId], references: [id], onDelete: Cascade)
  institutionId      String
  provider           BillingProvider
  providerPaymentId  String
  cardBrand          String?
  last4              String?
  expMonth           Int?
  expYear            Int?
  enabled            Boolean     @default(true)
  createdAt          DateTime    @default(now())
  updatedAt          DateTime    @updatedAt
}

model Invoice {
  id                 String       @id @default(uuid())
  institution        Institution  @relation(fields: [institutionId], references: [id], onDelete: Cascade)
  institutionId      String
  subscription       Subscription? @relation(fields: [subscriptionId], references: [id], onDelete: SetNull)
  subscriptionId     String?
  amountCents        Int
  currency           String       @default("INR")
  status             InvoiceStatus @default(PENDING)
  dueDate            DateTime?
  providerInvoiceId  String?
  metadata           Json?
  createdAt          DateTime     @default(now())
  updatedAt          DateTime     @updatedAt
}

model SystemBackup {
  id            String   @id @default(uuid())
  key           String
  sizeBytes     BigInt
  checksum      String
  status        String
  institution   Institution? @relation(fields: [institutionId], references: [id], onDelete: SetNull)
  institutionId String?
  createdAt     DateTime @default(now())
  meta          Json?
}

model TrialAbuseLog {
  id                String     @id @default(uuid())
  userId            String?
  institution       Institution? @relation(fields: [institutionId], references: [id], onDelete: SetNull)
  institutionId     String?
  hashedIp          String
  hashedUA          String?
  hashedDevice      String?
  hashedEmailDomain String?
  createdAt         DateTime   @default(now())
}

model PresignedUpload {
  id            String      @id @default(uuid())
  institution   Institution? @relation(fields: [institutionId], references: [id], onDelete: SetNull)
  institutionId String?
  fileKey       String      @unique
  fileUrl       String?
  fileSize      BigInt?
  fileType      String?
  createdBy     String?
  createdAt     DateTime    @default(now())
  expiresAt     DateTime
  used          Boolean     @default(false)
  meta          Json?
}

model BillingTransaction {
  id              String                     @id @default(uuid())
  provider        BillingProvider
  transactionId   String                     @unique
  institution     Institution?               @relation(fields: [institutionId], references: [id], onDelete: SetNull)
  institutionId   String?
  amountPaid      Float
  currency        String                     @default("INR")
  status          BillingTransactionStatus
  reconciledAt    DateTime?
  createdAt       DateTime                   @default(now())
  updatedAt       DateTime                   @updatedAt
  flagged         Boolean                    @default(false)
  metadata        Json?
}

model PlatformAnalytics {
  id                Int     @id @default(1)
  totalAthletes     Int
  totalInstitutions Int
  totalSessions     Int
  avgPerformance    Float?
  updatedAt         DateTime @updatedAt
}
