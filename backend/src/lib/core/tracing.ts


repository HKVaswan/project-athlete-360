/**
 * src/lib/core/tracing.ts
 * --------------------------------------------------------------------------
 * üéØ Core Tracing Abstraction Layer (Enterprise Grade)
 *
 * Purpose:
 *  - Provide unified, consistent tracing utilities across the backend.
 *  - Simplify usage of OpenTelemetry spans with automatic attributes, error capture,
 *    and cross-context propagation.
 *  - Integrate with otel.bootstrap.ts and system observability modules.
 *
 * Key Features:
 *  - traceFunction / traceAsyncFunction / traceRequest helpers
 *  - Auto-attach correlation IDs, user info, and environment metadata
 *  - Handles exceptions gracefully, preventing broken traces
 */

import { context, trace, Span, SpanStatusCode, SpanKind } from "@opentelemetry/api";
import { randomUUID } from "crypto";
import { config } from "../../config";
import { observabilityConfig } from "../../config/observabilityConfig";
import { logger } from "../../logger";

/* -----------------------------------------------------------------------
   üîß Global Tracer
------------------------------------------------------------------------ */
export const tracer = trace.getTracer(observabilityConfig.serviceName || "project-athlete-360");

/* -----------------------------------------------------------------------
   üß© Core Helper ‚Äî Start a Span Safely
------------------------------------------------------------------------ */
export const startSpan = (
  name: string,
  options: { kind?: SpanKind; attributes?: Record<string, any> } = {}
): Span => {
  try {
    const span = tracer.startSpan(name, {
      kind: options.kind ?? SpanKind.INTERNAL,
      attributes: {
        "service.name": observabilityConfig.serviceName,
        "env": config.NODE_ENV,
        "span.id": randomUUID(),
        ...options.attributes,
      },
    });
    return span;
  } catch (err: any) {
    logger.error(`[TRACING] Failed to start span: ${err.message}`);
    return {
      end: () => {},
      recordException: () => {},
      setStatus: () => {},
      setAttribute: () => {},
    } as unknown as Span; // fallback dummy span
  }
};

/* -----------------------------------------------------------------------
   ‚öôÔ∏è traceFunction (sync)
------------------------------------------------------------------------ */
/**
 * Wrap any synchronous function in a trace span.
 */
export const traceFunction = <T>(
  name: string,
  fn: () => T,
  attributes?: Record<string, any>
): T => {
  const span = startSpan(name, { attributes });
  try {
    const result = fn();
    span.setStatus({ code: SpanStatusCode.OK });
    return result;
  } catch (err: any) {
    span.recordException(err);
    span.setStatus({ code: SpanStatusCode.ERROR, message: err.message });
    logger.error(`[TRACE] ${name} failed`, { error: err.message });
    throw err;
  } finally {
    span.end();
  }
};

/* -----------------------------------------------------------------------
   ‚öôÔ∏è traceAsyncFunction (async)
------------------------------------------------------------------------ */
/**
 * Wrap any async function in a trace span with full error capture.
 */
export const traceAsyncFunction = async <T>(
  name: string,
  fn: () => Promise<T>,
  attributes?: Record<string, any>
): Promise<T> => {
  const span = startSpan(name, { attributes });
  try {
    const ctx = trace.setSpan(context.active(), span);
    const result = await context.with(ctx, fn);
    span.setStatus({ code: SpanStatusCode.OK });
    return result;
  } catch (err: any) {
    span.recordException(err);
    span.setStatus({ code: SpanStatusCode.ERROR, message: err.message });
    logger.error(`[TRACE] ${name} failed`, { error: err.message });
    throw err;
  } finally {
    span.end();
  }
};

/* -----------------------------------------------------------------------
   üåê traceRequest (Express middleware wrapper)
------------------------------------------------------------------------ */
/**
 * Creates an Express middleware that wraps each request in a trace span.
 * Automatically captures:
 *  - HTTP method, path, status code, and duration
 *  - Request ID and user info (if available)
 */
export const traceRequest =
  () => (req: any, res: any, next: any) => {
    const span = startSpan(`HTTP ${req.method} ${req.originalUrl}`, {
      kind: SpanKind.SERVER,
      attributes: {
        "http.method": req.method,
        "http.route": req.originalUrl,
        "user.id": req.user?.id || "guest",
        "x-request-id": req.headers["x-request-id"] || randomUUID(),
      },
    });

    const start = Date.now();

    res.on("finish", () => {
      const duration = Date.now() - start;
      span.setAttributes({
        "http.status_code": res.statusCode,
        "http.response_time_ms": duration,
      });

      if (res.statusCode >= 500)
        span.setStatus({ code: SpanStatusCode.ERROR, message: "Server error" });
      else
        span.setStatus({ code: SpanStatusCode.OK });

      span.end();
    });

    next();
  };

/* -----------------------------------------------------------------------
   üß† Contextual Span Logging (Optional)
------------------------------------------------------------------------ */
/**
 * Attaches contextual logs into the current active span.
 * Useful for deep debugging (e.g., inside workers or async chains).
 */
export const spanLog = (message: string, data?: Record<string, any>) => {
  const span = trace.getSpan(context.active());
  if (!span) return;
  try {
    span.addEvent(message, { ...data, timestamp: new Date().toISOString() });
  } catch (err: any) {
    logger.warn(`[TRACE LOG] Failed to record span event: ${err.message}`);
  }
};

/* -----------------------------------------------------------------------
   üßπ Shutdown (for graceful app exits)
------------------------------------------------------------------------ */
export const shutdownTracing = async () => {
  try {
    logger.info("[TRACING] Flushing traces before shutdown...");
    await new Promise((resolve) => setTimeout(resolve, 500)); // flush window
  } catch (err: any) {
    logger.error("[TRACING] Failed to flush traces", { error: err.message });
  }
};

/* -----------------------------------------------------------------------
   üì¶ Export API
------------------------------------------------------------------------ */
export default {
  tracer,
  startSpan,
  traceFunction,
  traceAsyncFunction,
  traceRequest,
  spanLog,
  shutdownTracing,
};