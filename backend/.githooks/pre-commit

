#!/usr/bin/env bash
# .githooks/pre-commit
# -----------------------------------------------------------------------------
# üß† Project Athlete 360 ‚Äì Enterprise Pre-commit Hook
#
# Purpose:
#  - Prevent secret leaks and insecure commits.
#  - Enforce linting & code quality before commit.
#  - Perform lightweight dependency security checks.
#
# Works together with:
#   ‚Üí tools/security/setup_precommit.sh
#   ‚Üí .secrets.baseline (detect-secrets baseline)
# -----------------------------------------------------------------------------

set -euo pipefail

echo "üîç [PA360] Running enterprise-grade pre-commit checks..."

# -----------------------------------------------------------------------------
# 1Ô∏è‚É£ Secret scanning (detect-secrets)
# -----------------------------------------------------------------------------
if command -v detect-secrets &> /dev/null; then
  detect-secrets-hook --baseline .secrets.baseline || {
    echo "‚ùå Secret scan failed. Resolve before committing."
    exit 1
  }
else
  echo "‚ö†Ô∏è detect-secrets not found; skipping secret check."
fi

# -----------------------------------------------------------------------------
# 2Ô∏è‚É£ Git-secrets verification
# -----------------------------------------------------------------------------
if command -v git-secrets &> /dev/null; then
  git secrets --pre_commit_hook || {
    echo "‚ùå git-secrets detected sensitive information. Aborting commit."
    exit 1
  }
else
  echo "‚ö†Ô∏è git-secrets not installed; skipping AWS/credential scan."
fi

# -----------------------------------------------------------------------------
# 3Ô∏è‚É£ Code linting (ESLint)
# -----------------------------------------------------------------------------
if command -v npx &> /dev/null; then
  echo "üßπ Running ESLint..."
  STAGED_FILES=$(git diff --cached --name-only --diff-filter=ACM | grep -E '\.(ts|js|tsx)$' || true)
  if [[ -n "$STAGED_FILES" ]]; then
    npx eslint --max-warnings=0 $STAGED_FILES || {
      echo "‚ùå ESLint errors found. Fix before committing."
      exit 1
    }
  else
    echo "‚ÑπÔ∏è No JS/TS files staged ‚Äî skipping lint."
  fi
else
  echo "‚ö†Ô∏è ESLint not found; skipping lint check."
fi

# -----------------------------------------------------------------------------
# 4Ô∏è‚É£ Dependency audit (lightweight, non-blocking)
# -----------------------------------------------------------------------------
if command -v npm &> /dev/null; then
  echo "üõ°Ô∏è Running quick npm audit..."
  npm audit --omit=dev --audit-level=high --json > /dev/null 2>&1 || {
    echo "‚ö†Ô∏è Vulnerabilities detected (non-blocking). Review with 'npm audit'."
  }
fi

# -----------------------------------------------------------------------------
# ‚úÖ Completion
# -----------------------------------------------------------------------------
echo "‚úÖ [PA360] All pre-commit checks passed successfully."
exit 0