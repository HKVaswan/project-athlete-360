// prisma/schema.prisma
// -----------------------------------------------------------------------------
// ðŸš€ Enterprise-Grade Prisma Schema â€” Project Athlete 360
// Database: PostgreSQL (set DATABASE_URL in .env)
// Notes:
//  - All relations are bidirectional where appropriate.
//  - Important fields indexed for performance (searches, joins).
//  - Use migrations to evolve schema: `npx prisma migrate dev`
// -----------------------------------------------------------------------------

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// -----------------------------------------------------------------------------
// ENUMS
// -----------------------------------------------------------------------------
enum Role {
  ATHLETE
  COACH
  ADMIN
  SUPER_ADMIN
  SYSTEM
}

enum SubscriptionStatus {
  TRIALING
  ACTIVE
  PAST_DUE
  CANCELED
  SUSPENDED
  EXPIRED
}

enum InvoiceStatus {
  DRAFT
  PENDING
  PAID
  FAILED
  VOID
}

enum InvitationStatus {
  PENDING
  ACCEPTED
  REVOKED
  EXPIRED
}

enum Attendance {
  PRESENT
  ABSENT
  EXCUSED
}

enum BillingProvider {
  STRIPE
  RAZORPAY
  MANUAL
}

enum BillingTransactionStatus {
  PENDING
  SUCCEEDED
  FAILED
  REFUNDED
  FLAGGED
}

// -----------------------------------------------------------------------------
// CORE MODELS
// -----------------------------------------------------------------------------

model User {
  id              String        @id @default(uuid())
  username        String        @unique
  email           String?       @unique
  passwordHash    String
  name            String?
  role            Role          @default(ATHLETE)
  institution     Institution?  @relation(fields: [institutionId], references: [id], onDelete: SetNull)
  institutionId   String?
  athlete         Athlete?
  coach           Coach?
  createdAt       DateTime      @default(now())
  updatedAt       DateTime      @updatedAt
  loginSessions   LoginSession[]
  refreshTokens   RefreshToken[]
  notifications   Notification[]
  invitations     Invitation[]  @relation("InvitedBy")
  acceptedInvites Invitation[]  @relation("AcceptedBy")
  auditLogs       AuditLog[]    @relation("AuditLogsByActor")
  meta            Json?
  deleted         Boolean       @default(false)
  deletedAt       DateTime?

  @@index([email])
  @@index([role])
  @@index([createdAt])
  @@map("users")
}

model Institution {
  id                  String                  @id @default(uuid())
  name                String
  code                String                  @unique
  domain              String?                 @unique
  createdAt           DateTime                @default(now())
  updatedAt           DateTime                @updatedAt
  users               User[]
  coaches             CoachInstitution[]
  athletes            Athlete[]
  invitations         Invitation[]
  subscriptions       Subscription[]
  usage               InstitutionUsage?
  analytics           InstitutionAnalytics?   @relation("InstitutionAnalyticsRelation")
  paymentMethods      PaymentMethod[]
  invoices            Invoice[]
  systemBackups       SystemBackup[]
  trialAbuseLogs      TrialAbuseLog[]
  presignedUploads    PresignedUpload[]
  billingTransactions BillingTransaction[]
  meta                Json?

  @@index([code])
  @@index([domain])
  @@index([createdAt])
  @@map("institutions")
}

// -----------------------------------------------------------------------------
// ATHLETE / COACH MODELS
// -----------------------------------------------------------------------------

model Athlete {
  id             String           @id @default(uuid())
  user           User             @relation(fields: [userId], references: [id], onDelete: Cascade)
  userId         String           @unique
  athleteCode    String           @unique
  name           String
  dob            DateTime?
  sport          String?
  gender         String?
  contactInfo    String?
  approved       Boolean          @default(false)
  institution    Institution?     @relation(fields: [institutionId], references: [id], onDelete: SetNull)
  institutionId  String?
  sessions       Session[]
  analytics      AthleteAnalytics? @relation("AthleteAnalyticsRelation")
  createdAt      DateTime         @default(now())
  updatedAt      DateTime         @updatedAt
  meta           Json?
  deleted        Boolean          @default(false)
  deletedAt      DateTime?

  @@index([athleteCode])
  @@index([institutionId])
  @@index([createdAt])
  @@map("athletes")
}

model Coach {
  id             String           @id @default(uuid())
  user           User             @relation(fields: [userId], references: [id], onDelete: Cascade)
  userId         String           @unique
  coachCode      String           @unique
  name           String?
  institutions   CoachInstitution[]
  createdAt      DateTime         @default(now())
  updatedAt      DateTime         @updatedAt
  meta           Json?
  deleted        Boolean          @default(false)
  deletedAt      DateTime?

  @@index([coachCode])
  @@map("coaches")
}

model CoachInstitution {
  id             String      @id @default(uuid())
  coach          Coach       @relation(fields: [coachId], references: [id], onDelete: Cascade)
  coachId        String
  institution    Institution @relation(fields: [institutionId], references: [id], onDelete: Cascade)
  institutionId  String
  createdAt      DateTime    @default(now())

  @@unique([coachId, institutionId])
  @@index([institutionId])
  @@map("coach_institutions")
}

// -----------------------------------------------------------------------------
// SESSIONS / PERFORMANCE
// -----------------------------------------------------------------------------

model Session {
  id               String      @id @default(uuid())
  athlete          Athlete     @relation(fields: [athleteId], references: [id], onDelete: Cascade)
  athleteId        String
  coachId          String?
  attendance       Attendance?
  performanceScore Float?
  notes            String?
  createdAt        DateTime    @default(now())
  updatedAt        DateTime    @updatedAt
  meta             Json?

  @@index([athleteId])
  @@index([createdAt])
  @@map("sessions")
}

// -----------------------------------------------------------------------------
// INVITATIONS
// -----------------------------------------------------------------------------

model Invitation {
  id              String            @id @default(uuid())
  email           String
  role            Role
  tokenHash       String
  invitedBy       User              @relation("InvitedBy", fields: [invitedById], references: [id], onDelete: Cascade)
  invitedById     String
  institution     Institution       @relation(fields: [institutionId], references: [id], onDelete: Cascade)
  institutionId   String
  acceptedBy      User?             @relation("AcceptedBy", fields: [acceptedById], references: [id], onDelete: SetNull)
  acceptedById    String?
  status          InvitationStatus  @default(PENDING)
  message         String?
  expiresAt       DateTime
  acceptedAt      DateTime?
  revokedAt       DateTime?
  revokeReason    String?
  createdAt       DateTime          @default(now())
  updatedAt       DateTime          @updatedAt

  @@index([email])
  @@index([status])
  @@index([tokenHash])
  @@map("invitations")
}

// -----------------------------------------------------------------------------
// SECURITY / AUTHENTICATION
// -----------------------------------------------------------------------------

model RefreshToken {
  id          String   @id @default(uuid())
  user        User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  userId      String
  tokenHash   String
  deviceInfo  String?
  issuedAt    DateTime @default(now())
  expiresAt   DateTime
  revoked     Boolean  @default(false)
  createdAt   DateTime @default(now())

  @@index([userId])
  @@index([tokenHash])
  @@map("refresh_tokens")
}

model LoginSession {
  id          String   @id @default(uuid())
  user        User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  userId      String
  ipAddress   String?
  userAgent   String?
  loggedInAt  DateTime @default(now())
  meta        Json?
  createdAt   DateTime @default(now())

  @@index([userId])
  @@map("login_sessions")
}

// -----------------------------------------------------------------------------
// BILLING / PLANS
// -----------------------------------------------------------------------------

model Plan {
  id                    String         @id @default(uuid())
  sku                   String         @unique
  name                  String
  description           String?
  priceMonthlyCents     Int            @default(0)
  storageLimitBytes     BigInt         @default(0)
  videoLimitPerMonth    Int            @default(0)
  athletesPerCoach      Int            @default(50)
  coachesPerInstitution Int            @default(10)
  features              Json?
  isDefault             Boolean        @default(false)
  createdAt             DateTime       @default(now())
  updatedAt             DateTime       @updatedAt
  subscriptions         Subscription[]

  @@index([sku])
  @@map("plans")
}

model Subscription {
  id                      String             @id @default(uuid())
  institution              Institution        @relation(fields: [institutionId], references: [id], onDelete: Cascade)
  institutionId            String
  plan                     Plan               @relation(fields: [planId], references: [id], onDelete: Restrict)
  planId                   String
  status                   SubscriptionStatus @default(TRIALING)
  startDate                DateTime           @default(now())
  endDate                  DateTime?
  nextBillingDate          DateTime?
  paymentProvider          BillingProvider?
  providerCustomerId       String?
  providerSubscriptionId   String?
  usedFreeTrial            Boolean            @default(false)
  autoRenew                Boolean            @default(true)
  canceledAt               DateTime?
  invoices                 Invoice[]
  createdAt                DateTime           @default(now())
  updatedAt                DateTime           @updatedAt

  @@index([institutionId])
  @@index([status])
  @@map("subscriptions")
}

// -----------------------------------------------------------------------------
// NOTIFICATIONS
// -----------------------------------------------------------------------------

model Notification {
  id             String    @id @default(uuid())
  user           User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  userId         String
  title          String
  message        String
  type           String    @default("GENERAL")
  priority       String    @default("normal")
  channel        String?
  read           Boolean   @default(false)
  readAt         DateTime?
  delivered      Boolean   @default(false)
  deliveredAt    DateTime?
  metadata       Json?
  createdAt      DateTime  @default(now())
  updatedAt      DateTime  @updatedAt

  @@index([userId])
  @@index([type])
  @@index([priority])
  @@index([createdAt])
  @@map("notifications")
}

// -----------------------------------------------------------------------------
// ANALYTICS
// -----------------------------------------------------------------------------

model AthleteAnalytics {
  athleteId      String    @id
  athlete        Athlete   @relation("AthleteAnalyticsRelation", fields: [athleteId], references: [id], onDelete: Cascade)
  avgScore       Float?
  attendanceRate Float?
  updatedAt      DateTime  @updatedAt

  @@map("athlete_analytics")
}

model InstitutionAnalytics {
  institutionId  String      @id
  institution    Institution @relation("InstitutionAnalyticsRelation", fields: [institutionId], references: [id], onDelete: Cascade)
  avgPerformance Float?
  attendanceRate Float?
  updatedAt      DateTime    @updatedAt

  @@map("institution_analytics")
}

// -----------------------------------------------------------------------------
// SYSTEM / BILLING / SECURITY MODELS
// -----------------------------------------------------------------------------

model AuditLog {
  id           String   @id @default(uuid())
  actorId      String?
  actor        User?    @relation("AuditLogsByActor", fields: [actorId], references: [id], onDelete: SetNull)
  actorRole    String?
  action       String
  entity       String?
  entityId     String?
  details      Json?
  metadata     Json?
  chainHash    String
  previousHash String?
  createdAt    DateTime @default(now())

  @@index([actorId])
  @@index([action])
  @@index([createdAt])
  @@map("audit_logs")
}

model InstitutionUsage {
  institution      Institution @relation(fields: [institutionId], references: [id], onDelete: Cascade)
  institutionId    String      @id
  storageBytes     BigInt      @default(0)
  videoCountMonth  Int         @default(0)
  athletesCount    Int         @default(0)
  coachesCount     Int         @default(0)
  lastReconciledAt DateTime?
  updatedAt        DateTime    @updatedAt
  meta             Json?

  @@map("institution_usage")
}

model PaymentMethod {
  id                 String      @id @default(uuid())
  institution        Institution @relation(fields: [institutionId], references: [id], onDelete: Cascade)
  institutionId      String
  provider           BillingProvider
  providerPaymentId  String
  cardBrand          String?
  last4              String?
  expMonth           Int?
  expYear            Int?
  enabled            Boolean     @default(true)
  createdAt          DateTime    @default(now())
  updatedAt          DateTime    @updatedAt

  @@index([institutionId])
  @@map("payment_methods")
}

model Invoice {
  id                 String        @id @default(uuid())
  institution        Institution    @relation(fields: [institutionId], references: [id], onDelete: Cascade)
  institutionId      String
  subscription       Subscription?  @relation(fields: [subscriptionId], references: [id], onDelete: SetNull)
  subscriptionId     String?
  amountCents        Int
  currency           String        @default("INR")
  status             InvoiceStatus @default(PENDING)
  dueDate            DateTime?
  providerInvoiceId  String?
  metadata           Json?
  createdAt          DateTime      @default(now())
  updatedAt          DateTime      @updatedAt

  @@index([institutionId])
  @@index([status])
  @@map("invoices")
}

model BillingTransaction {
  id              String   @id @default(uuid())
  provider        BillingProvider
  transactionId   String   @unique
  institution     Institution? @relation(fields: [institutionId], references: [id], onDelete: SetNull)
  institutionId   String?
  amountPaid      Float
  currency        String   @default("INR")
  status          BillingTransactionStatus
  reconciledAt    DateTime?
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
  flagged         Boolean  @default(false)
  metadata        Json?

  @@index([provider])
  @@map("billing_transactions")
}

model BillingEvent {
  id                    String             @id @default(uuid())
  eventId               String             @unique
  type                  String
  provider              BillingProvider
  billingTransactionId  String?
  billingTransaction    BillingTransaction? @relation(fields: [billingTransactionId], references: [id], onDelete: SetNull)
  payload               Json?
  createdAt             DateTime           @default(now())

  @@index([provider])
  @@map("billing_events")
}

// -----------------------------------------------------------------------------
// BACKUPS / STORAGE / ABUSE
// -----------------------------------------------------------------------------

model SystemBackup {
  id            String   @id @default(uuid())
  key           String
  sizeBytes     BigInt
  checksum      String
  status        String
  institution   Institution? @relation(fields: [institutionId], references: [id], onDelete: SetNull)
  institutionId String?
  createdAt     DateTime @default(now())
  meta          Json?

  @@map("system_backups")
}

model KeyBackup {
  id            String   @id @default(uuid())
  backupId      String   @unique
  jwtSecret     String   // store encrypted externally; secrets manager recommended
  encryptionKey String
  createdAt     DateTime @default(now())
  meta          Json?

  @@map("key_backups")
}

model TrialAbuseLog {
  id                String     @id @default(uuid())
  userId            String?
  institution       Institution? @relation(fields: [institutionId], references: [id], onDelete: SetNull)
  institutionId     String?
  hashedIp          String
  hashedUA          String?
  hashedDevice      String?
  hashedEmailDomain String?
  createdAt         DateTime   @default(now())

  @@index([hashedIp])
  @@index([institutionId])
  @@map("trial_abuse_logs")
}

model PresignedUpload {
  id            String      @id @default(uuid())
  institution   Institution? @relation(fields: [institutionId], references: [id], onDelete: SetNull)
  institutionId String?
  fileKey       String      @unique
  fileUrl       String?
  fileSize      BigInt?
  fileType      String?
  createdBy     String?
  createdAt     DateTime    @default(now())
  expiresAt     DateTime
  used          Boolean     @default(false)
  meta          Json?

  @@index([institutionId])
  @@map("presigned_uploads")
}

model PlatformAnalytics {
  id                Int     @id @default(1)
  totalAthletes     Int
  totalInstitutions Int
  totalSessions     Int
  avgPerformance    Float?
  updatedAt         DateTime @updatedAt

  @@map("platform_analytics")
}

// -----------------------------------------------------------------------------
// MISC MODELS
// -----------------------------------------------------------------------------

model BlockedIP {
  id          String   @id @default(uuid())
  ipHash      String   @unique
  reason      String?
  blockedById String?
  createdAt   DateTime @default(now())
  expiresAt   DateTime?
  resolved    Boolean  @default(false)
  meta        Json?

  @@map("blocked_ips")
}

model IPReputation {
  id        String   @id @default(uuid())
  ipHash    String   @unique
  score     Int      @default(0)
  lastSeen  DateTime @default(now())
  meta      Json?

  @@map("ip_reputation")
}

model SystemAlert {
  id          String   @id @default(uuid())
  title       String
  message     String
  severity    String   @default("medium")
  category    String?
  metadata    Json?
  resolved    Boolean  @default(false)
  createdAt   DateTime @default(now())
  resolvedAt  DateTime?

  @@map("system_alerts")
}

model EmailLog {
  id          String   @id @default(uuid())
  to          String
  subject     String
  status      String   @default("SENT")
  provider    String?
  error       String?
  createdAt   DateTime @default(now())
  meta        Json?

  @@map("email_logs")
}
