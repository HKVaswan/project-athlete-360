/**
 * tests/integration/metrics_exposure.spec.ts
 * --------------------------------------------------------------------
 * ðŸ§  Enterprise Integration Test: Metrics Exposure & Observability
 *
 * Purpose:
 *   - Validate /metrics endpoint health, format, and security
 *   - Ensure no sensitive data exposure
 *   - Confirm Prometheus and OpenTelemetry integration correctness
 *   - Measure endpoint latency and registry health under load
 * --------------------------------------------------------------------
 */

import request from "supertest";
import http from "http";
import app from "../../src/app";
import { config } from "../../src/config";
import { register } from "../../src/lib/core/tracing"; // Prometheus registry (if exposed)
import { trace, context } from "@opentelemetry/api";

let server: http.Server;

describe("ðŸ§  Metrics Exposure & Observability Suite", () => {
  beforeAll(async () => {
    // Clean Prometheus registry (if supported)
    if (register && typeof (register as any).clear === "function") {
      (register as any).clear();
    }

    // Start app on ephemeral port
    server = app.listen(0);
  });

  afterAll(async () => {
    if (server) {
      await new Promise((resolve) => server.close(resolve));
    }
  });

  /* -----------------------------------------------------------
   * 1ï¸âƒ£ Metrics Endpoint Availability
   * --------------------------------------------------------- */
  it("should expose /metrics endpoint successfully", async () => {
    const res = await request(server).get("/metrics").expect(200);
    expect(res.text).toContain("# HELP");
    expect(res.text).toContain("process_cpu_user_seconds_total");
    expect(res.text).toContain("pa360_http_requests_total");
  });

  /* -----------------------------------------------------------
   * 2ï¸âƒ£ Prometheus Format Validation
   * --------------------------------------------------------- */
  it("should return valid Prometheus exposition format", async () => {
    const res = await request(server).get("/metrics").expect(200);
    const lines = res.text.trim().split("\n");
    expect(lines[0].startsWith("#")).toBe(true);
    const metricLine = lines.find((l) => l && !l.startsWith("#"));
    expect(metricLine).toMatch(/^[a-zA-Z_:][a-zA-Z0-9_:]*\s[0-9eE\+\-\.]+/);
  });

  /* -----------------------------------------------------------
   * 3ï¸âƒ£ Sensitive Data Validation
   * --------------------------------------------------------- */
  it("should not contain sensitive data in metrics output", async () => {
    const res = await request(server).get("/metrics").expect(200);
    expect(res.text).not.toMatch(/password|token|secret|apikey|authorization/i);
  });

  /* -----------------------------------------------------------
   * 4ï¸âƒ£ Core Metrics Presence Check
   * --------------------------------------------------------- */
  it("should contain essential HTTP and latency metrics", async () => {
    const res = await request(server).get("/metrics").expect(200);
    expect(res.text).toContain("pa360_http_requests_total");
    expect(res.text).toContain("pa360_http_request_duration_seconds_bucket");
    expect(res.text).toMatch(/_bucket\{.*le="1"\}/); // lower bound
    expect(res.text).toMatch(/_bucket\{.*le="\+Inf"\}/); // upper bound
  });

  /* -----------------------------------------------------------
   * 5ï¸âƒ£ Worker Queue Metrics
   * --------------------------------------------------------- */
  it("should include worker/queue metrics when available", async () => {
    const res = await request(server).get("/metrics").expect(200);
    const hasWorkerMetric =
      res.text.includes("pa360_worker_jobs_active") ||
      res.text.includes("pa360_worker_jobs_failed_total") ||
      res.text.includes("pa360_worker_duration_seconds_bucket");
    expect(hasWorkerMetric).toBe(true);
  });

  /* -----------------------------------------------------------
   * 6ï¸âƒ£ Endpoint Latency Under Load
   * --------------------------------------------------------- */
  it("should respond within 1s under normal conditions", async () => {
    const start = Date.now();
    await request(server).get("/metrics").expect(200);
    const latency = Date.now() - start;
    expect(latency).toBeLessThan(1000);
  });

  /* -----------------------------------------------------------
   * 7ï¸âƒ£ Secure Access Validation
   * --------------------------------------------------------- */
  it("should support secure access enforcement when enabled", async () => {
    if (config.metrics?.requireAuth) {
      const res = await request(server)
        .get("/metrics")
        .set("Authorization", "Bearer invalid_token")
        .expect(401);
      expect(res.body.message).toMatch(/unauthorized/i);
    } else {
      const res = await request(server).get("/metrics").expect(200);
      expect(res.text.length).toBeGreaterThan(10);
    }
  });

  /* -----------------------------------------------------------
   * 8ï¸âƒ£ Health Endpoint Independence
   * --------------------------------------------------------- */
  it("should allow /health to respond independently from /metrics", async () => {
    const res = await request(server).get("/health").expect(200);
    expect(res.body).toHaveProperty("success", true);
    expect(res.body.message).toMatch(/healthy/i);
  });

  /* -----------------------------------------------------------
   * 9ï¸âƒ£ OpenTelemetry Exporter Validation
   * --------------------------------------------------------- */
  it("should verify OpenTelemetry exporter registration (if enabled)", async () => {
    if (config.observability?.otelEnabled && register?.getMetricsAsJSON) {
      const metrics = await register.getMetricsAsJSON();
      const metricNames = metrics.map((m: any) => m.name);
      expect(metricNames).toContain("pa360_http_requests_total");
    }
  });

  /* -----------------------------------------------------------
   * ðŸ”Ÿ Trace Context Isolation Check
   * --------------------------------------------------------- */
  it("should not produce new tracing spans for /metrics endpoint", async () => {
    const res = await request(server).get("/metrics").expect(200);
    expect(res.text).toContain("pa360_http_requests_total");

    const activeSpan = trace.getSpan(context.active());
    // Metrics endpoint should not create its own spans
    expect(activeSpan).toBeNull();
  });
});