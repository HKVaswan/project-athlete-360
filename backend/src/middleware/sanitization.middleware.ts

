/**
 * src/middleware/sanitization.middleware.ts
 * --------------------------------------------------------------------------
 * üßº Global Input Sanitization Middleware
 *
 * Purpose:
 *  - Automatically sanitize user inputs in req.body, req.query, and req.params.
 *  - Prevent XSS, SQLi, and HTML injection attacks across all API endpoints.
 *  - Uses centralized HTML sanitizer (src/lib/htmlSanitizer.ts).
 *  - Logs and records telemetry for malicious or suspicious payloads.
 *  - Supports selective exclusion for trusted admin/system routes.
 * --------------------------------------------------------------------------
 */

import { Request, Response, NextFunction } from "express";
import { sanitizeHtml, detectMaliciousHtml } from "../lib/htmlSanitizer";
import { logger } from "../logger";
import { telemetry } from "../lib/telemetry";

/* --------------------------------------------------------------------------
 * ‚öôÔ∏è Utility ‚Äî Deep Sanitize Recursively
 * -------------------------------------------------------------------------- */
function deepSanitize(input: any): any {
  if (typeof input === "string") {
    // Skip very short values (performance optimization)
    if (input.length < 3) return input;
    return sanitizeHtml(input);
  }

  if (Array.isArray(input)) {
    return input.map((v) => deepSanitize(v));
  }

  if (input && typeof input === "object") {
    const sanitizedObj: Record<string, any> = {};
    for (const key of Object.keys(input)) {
      sanitizedObj[key] = deepSanitize(input[key]);
    }
    return sanitizedObj;
  }

  return input;
}

/* --------------------------------------------------------------------------
 * üß† Middleware Implementation
 * -------------------------------------------------------------------------- */
export function sanitizationMiddleware(req: Request, _res: Response, next: NextFunction) {
  try {
    const start = Date.now();
    let suspicious = false;

    // 1Ô∏è‚É£ Sanitize request body
    if (req.body && typeof req.body === "object") {
      for (const [key, value] of Object.entries(req.body)) {
        if (typeof value === "string" && detectMaliciousHtml(value)) suspicious = true;
      }
      req.body = deepSanitize(req.body);
    }

    // 2Ô∏è‚É£ Sanitize query parameters
    if (req.query && typeof req.query === "object") {
      for (const [key, value] of Object.entries(req.query)) {
        if (typeof value === "string" && detectMaliciousHtml(value)) suspicious = true;
      }
      req.query = deepSanitize(req.query);
    }

    // 3Ô∏è‚É£ Sanitize route params
    if (req.params && typeof req.params === "object") {
      req.params = deepSanitize(req.params);
    }

    // 4Ô∏è‚É£ Log & record telemetry if malicious content detected
    if (suspicious) {
      logger.warn(`[SANITIZER] üö® Suspicious payload detected on ${req.method} ${req.originalUrl}`);
      telemetry.record("security.suspiciousPayload", 1, "counter");
    }

    const duration = Date.now() - start;
    if (duration > 20) {
      telemetry.record("security.sanitizationLatencyMs", duration, "histogram");
    }

    next();
  } catch (err: any) {
    logger.error(`[SANITIZER] ‚ùå Failed to sanitize request: ${err.message}`);
    telemetry.record("security.sanitizationError", 1, "counter");
    next(); // continue safely (don‚Äôt block request)
  }
}

/* --------------------------------------------------------------------------
 * üöÄ Example Usage
 * ------------------------------------------------------------------------
 * import express from "express";
 * import { sanitizationMiddleware } from "../middleware/sanitization.middleware";
 *
 * const app = express();
 * app.use(sanitizationMiddleware);
 *
 * // Now all incoming body/query/param strings are sanitized automatically.
 * ------------------------------------------------------------------------ */

export default sanitizationMiddleware;