name: ğŸ§  Observability & Telemetry CI Check

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]
  workflow_dispatch:

permissions:
  contents: read

env:
  NODE_ENV: test
  CI: true
  METRICS_PORT: 9464
  OTLP_ENDPOINT: http://localhost:4318/v1/traces
  PROMETHEUS_ENABLED: true
  OBSERVABILITY_ENABLED: true

jobs:
  observability-ci:
    name: ğŸ” Validate Observability & Tracing Integrity
    runs-on: ubuntu-latest
    timeout-minutes: 15

    services:
      redis:
        image: redis:7
        ports:
          - 6379:6379
        options: >-
          --health-cmd "redis-cli ping"
          --health-interval 5s
          --health-timeout 3s
          --health-retries 5

      postgres:
        image: postgres:15
        env:
          POSTGRES_USER: postgres
          POSTGRES_PASSWORD: postgres
          POSTGRES_DB: pa360_test
        ports:
          - 5432:5432
        options: >-
          --health-cmd "pg_isready -U postgres"
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5

    steps:
      - name: ğŸ§© Checkout repository
        uses: actions/checkout@v4

      - name: âš™ï¸ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "20"
          cache: "npm"

      - name: ğŸ“¦ Install dependencies
        run: npm ci

      - name: ğŸ§± Build backend
        run: npm run build --workspaces || npm run build

      - name: ğŸ§  Start observability stack (Prometheus + OTel)
        run: |
          docker compose -f infra/docker-compose.yml up -d prometheus jaeger grafana
          echo "Waiting for Prometheus and Jaeger to start..."
          sleep 15

      - name: ğŸ§ª Run Observability Tests
        run: |
          echo "Running integration tests for metrics and tracing..."
          npx jest tests/integration/metrics_exposure.spec.ts --runInBand --detectOpenHandles --forceExit
          npx jest tests/integration/tracing_correlation.spec.ts --runInBand --detectOpenHandles --forceExit

      - name: ğŸ“Š Verify Prometheus endpoint health
        run: |
          curl -f http://localhost:9464/metrics | grep "pa360_http_requests_total" || (echo "âŒ Metrics missing" && exit 1)

      - name: ğŸ”— Validate OpenTelemetry endpoint availability
        run: |
          curl -sf ${OTLP_ENDPOINT} || echo "âš ï¸ OTLP endpoint not responding (expected if local mode)"

      - name: ğŸ§¹ Clean up environment
        if: always()
        run: |
          docker compose -f infra/docker-compose.yml down -v || true
          echo "Cleanup complete."

      - name: âœ… Summary
        if: success()
        run: |
          echo "âœ… Observability Integrity Check completed successfully."
          echo " - Metrics exposed âœ…"
          echo " - Traces linked âœ…"
          echo " - Logs correlated âœ…"

      - name: ğŸš¨ Failure Summary
        if: failure()
        run: |
          echo "âŒ Observability CI failed!"
          echo "Check logs above for metrics/tracing integration issues."